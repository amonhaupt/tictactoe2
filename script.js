/// COLOR PALLETES ///
const preloadPallete = {
    backgroundColor:      "#000000",
    textColor:            "#000000",
    menuButtonColor:      "#000000",
    squareBorder:         "#000000",
    lightSquareBorder:    "#000000",
    disabledSquareBorder: "#000000",
    colorO:               "#000000",
    colorX:               "#000000" 
}

const standardPallete = {
    backgroundColor:      "#153448",
    textColor:            "#F7F7F7",
    menuButtonColor:      "#C9E4F7",
    squareBorder:         "#3c5b6f",
    lightSquareBorder:    "#C9E4F7",
    disabledSquareBorder: "rgba(201, 228, 247, 0.1)",
    colorO:               "#3498db",
    colorX:               "#ff6666"
};

const earthPalette = {
    backgroundColor:      "#2E3D25",
    textColor:            "#F4F1DE",
    menuButtonColor:      "#A9CBB7",
    squareBorder:         "#556B2F",
    lightSquareBorder:    "#A9CBB7",
    disabledSquareBorder: "rgba(169, 203, 183, 0.1)",
    colorO:               "#8FBC8F",
    colorX:               "#D2691E"
}

const neonPalette = {
    backgroundColor:      "#181F38",
    textColor:            "#E0FFFA",
    menuButtonColor:      "#5DFDCB",
    squareBorder:         "#2C5364",
    lightSquareBorder:    "#5DFDCB",
    disabledSquareBorder: "rgba(93, 253, 203, 0.1)",
    colorO:               "#00B8A9",
    colorX:               "#FF2E63"
}

const sunsetPalette = {
    backgroundColor:      "#3B1F2B",
    textColor:            "#FFF8E7",
    menuButtonColor:      "#FFB677",
    squareBorder:         "#A23E48",
    lightSquareBorder:    "#FFB677",
    disabledSquareBorder: "rgba(255, 182, 119, 0.1)",
    colorO:               "#FF7043",
    colorX:               "#FFD166"
}

const pastelPalette = {
    backgroundColor:      "#DDE6ED",
    textColor:            "#2E3A59",
    menuButtonColor:      "#89CFF0",
    squareBorder:         "#7A9CC6",
    lightSquareBorder:    "#B0D0F0",
    disabledSquareBorder: "rgba(137, 207, 240, 0.2)",
    colorO:               "#4A90E2",
    colorX:               "#E94F37"
}

const retroArcadePalette = {
    backgroundColor:      "#22223B",
    textColor:            "#F2E9E4",
    menuButtonColor:      "#F26CA7",
    squareBorder:         "#4A4E69",
    lightSquareBorder:    "#F26CA7",
    disabledSquareBorder: "rgba(242, 108, 167, 0.1)",
    colorO:               "#38B6FF",
    colorX:               "#FFDE59"
}

const forestNightPalette = {
    backgroundColor:      "#232D23",
    textColor:            "#D6E5E3",
    menuButtonColor:      "#7CA982",
    squareBorder:         "#3C5A3A",
    lightSquareBorder:    "#7CA982",
    disabledSquareBorder: "rgba(124, 169, 130, 0.1)",
    colorO:               "#A3C1AD",
    colorX:               "#D9853B"
}

const oceanPalette = {
    backgroundColor:      "#142850",
    textColor:            "#F9F9F9",
    menuButtonColor:      "#00A8CC",
    squareBorder:         "#27496D",
    lightSquareBorder:    "#00A8CC",
    disabledSquareBorder: "rgba(0, 168, 204, 0.1)",
    colorO:               "#3AB795",
    colorX:               "#F67280"
};

const lavenderPalette = {
    backgroundColor:      "#6D597A",
    textColor:            "#F6F6F6",
    menuButtonColor:      "#B56576",
    squareBorder:         "#355C7D",
    lightSquareBorder:    "#B56576",
    disabledSquareBorder: "rgba(181, 101, 118, 0.1)",
    colorO:               "#9AD0EC",
    colorX:               "#E56B6F"
};

const desertPalette = {
    backgroundColor:      "#3E2723",
    textColor:            "#FBEEC1",
    menuButtonColor:      "#E07A5F",
    squareBorder:         "#A0522D",
    lightSquareBorder:    "#E07A5F",
    disabledSquareBorder: "rgba(224, 122, 95, 0.1)",
    colorO:               "#F2CC8F",
    colorX:               "#81B29A"
};

const lemonPalette = {
    backgroundColor:      "#FFFBEA",
    textColor:            "#22223B",
    menuButtonColor:      "#FFE066",
    squareBorder:         "#FFD23F",
    lightSquareBorder:    "#FFE066",
    disabledSquareBorder: "rgba(255, 224, 102, 0.1)",
    colorO:               "#FFB400",
    colorX:               "#FF6363"
};

const peachPalette = {
    backgroundColor:      "#FFF1E6",
    textColor:            "#22223B",
    menuButtonColor:      "#FFB4A2",
    squareBorder:         "#F08080",
    lightSquareBorder:    "#FFB4A2",
    disabledSquareBorder: "rgba(255, 180, 162, 0.1)",
    colorO:               "#F4978E",
    colorX:               "#F9C784"
};

const duskGrey = {
    backgroundColor:      "#2F3E46",
    textColor:            "#CAD2C5",
    menuButtonColor:      "#52796F",
    squareBorder:         "#354F52",
    lightSquareBorder:    "#52796F",
    disabledSquareBorder: "rgba(82, 121, 111, 0.1)",
    colorO:               "#84A98C",
    colorX:               "#D90429"
};

const pineBrickPalette = {
    backgroundColor:      "#2E2F27",
    textColor:            "#D9D9D6",
    menuButtonColor:      "#B73225",
    squareBorder:         "#4A5A4F",
    lightSquareBorder:    "#B73225",
    disabledSquareBorder: "rgba(183, 50, 37, 0.1)",
    colorO:               "#004E7C",
    colorX:               "#A63A3A"
};

const infraredPalette = {
    backgroundColor:      "#283747",
    textColor:            "#F3F3F3",
    menuButtonColor:      "#3C1874",
    squareBorder:         "#932432",
    lightSquareBorder:    "#3C1874",
    disabledSquareBorder: "rgba(60, 24, 116, 0.1)",
    colorO:               "#DE354C",
    colorX:               "#932432"
};

const bluePalette = {
    backgroundColor:      "#E0F7FA",
    textColor:            "#142850",
    menuButtonColor:      "#3C1874",
    squareBorder:         "#27496D",
    lightSquareBorder:    "#3C1874",
    disabledSquareBorder: "rgba(60, 24, 116, 0.1)",
    colorO:               "#52796F",
    colorX:               "#FF2E63"
};


const honeyPalette = {
    backgroundColor:      "#DCE1E3",
    textColor:            "#5C5F58",
    menuButtonColor:      "#FACF39",
    squareBorder:         "#B17A50",
    lightSquareBorder:    "#FACF39",
    disabledSquareBorder: "rgba(250, 207, 57, 0.1)",
    colorO:               "#B73225",
    colorX:               "#004E7C"
};

const mintPalette = {
    backgroundColor:      "#2E3D25",
    textColor:            "#F4F1DE",
    menuButtonColor:      "#A9CBB7",
    squareBorder:         "#556B2F",
    lightSquareBorder:    "#A9CBB7",
    disabledSquareBorder: "rgba(169, 203, 183, 0.1)",
    colorO:               "#8FBC8F",
    colorX:               "#D2691E"
};

const violetPalette = {
    backgroundColor:      "#3B1F2B",
    textColor:            "#FFF8E7",
    menuButtonColor:      "#9B59B6",
    squareBorder:         "#6C3483",
    lightSquareBorder:    "#9B59B6",
    disabledSquareBorder: "rgba(155, 89, 182, 0.1)",
    colorO:               "#8E44AD",
    colorX:               "#E74C3C"
};

const blackPalette = {
    backgroundColor:      "#000000",
    textColor:            "#FFFFFF",
    menuButtonColor:      "#333333",
    squareBorder:         "#555555",
    lightSquareBorder:    "#777777",
    disabledSquareBorder: "rgba(255, 255, 255, 0.1)",
    colorO:               "#00FFFF",
    colorX:               "#FF4500"
}

const whitePalette = {
    backgroundColor:      "#FFFFFF",
    textColor:            "#222222",
    menuButtonColor:      "#DDDDDD",
    squareBorder:         "#AAAAAA",
    lightSquareBorder:    "#EEEEEE",
    disabledSquareBorder: "rgba(34, 34, 34, 0.1)",
    colorO:               "#007ACC",
    colorX:               "#D9534F"
}

let activeColorPallete = "preloadPallete";
const palettes = {
    standardPallete,
    earthPalette,
    neonPalette,
    sunsetPalette,
    pastelPalette,
    retroArcadePalette,
    forestNightPalette,
    oceanPalette,
    lavenderPalette,
    desertPalette,
    lemonPalette,
    peachPalette,
    duskGrey,
    pineBrickPalette,
    infraredPalette,
    bluePalette,
    honeyPalette,
    mintPalette,
    violetPalette,
    blackPalette,
    whitePalette
};
  
const colorPalletes = [
    { id: "standardPallete", label: "Standard" },
    { id: "earthPalette", label: "Earth" },
    { id: "neonPalette", label: "Neon" },
    { id: "sunsetPalette", label: "Sunset" },
    { id: "pastelPalette", label: "Pastel" },
    { id: "retroArcadePalette", label: "Retro Arcade" },
    { id: "forestNightPalette", label: "Forest Night" },
    { id: "oceanPalette", label: "Ocean" },
    { id: "lavenderPalette", label: "Lavender" },
    { id: "desertPalette", label: "Desert" },
    { id: "lemonPalette", label: "Lemon" },
    { id: "peachPalette", label: "Peach" },
    { id: "duskGrey", label: "Dusk Grey" },
    { id: "pineBrickPalette", label: "Pine Brick" },
    { id: "infraredPalette", label: "Infrared" },
    { id: "bluePalette", label: "Blue" },
    { id: "honeyPalette", label: "Honey" },
    { id: "mintPalette", label: "Mint" },
    { id: "violetPalette", label: "Violet" },
    { id: "blackPalette", label: "Black" },
    { id: "whitePalette", label: "White" }
  ];

// GAME //
let gameState = {
    globalBoard: ["", "", "", "", "", "", "", "", ""],
    subBoards: [
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", ""]
    ],
    currentPlayer: "X",
    playingAgainstComputer: false,
    computerToMove: false,
    activeSubBoard: null,
    lastMove: {
        subBoard: null,
        cell: null,
        player: null
    },
    ended: false,
};

let gameSettings = {
    startingPlayer: "X",
    playingAgainstComputer: false,
    computerStarts: false
}

const winPatterns = [
    [0, 1, 2],
    [0, 3, 6],
    [0, 4, 8],
    [1, 4, 7],
    [2, 5, 8],
    [2, 4, 6],
    [3, 4, 5],
    [6, 7, 8]
];
let computerDifficulty = 2;


let previousButton = document.createElement("button");
let squares = document.querySelectorAll(".square");
let squareContainers = document.querySelectorAll(".square-container");
let gameContainer = document.getElementsByClassName("game-container")[0];

// ON PAGE LOAD //


loadThemeButtons();
loadSettings();
loadGameSettings();
loadGame();

window.onload = function() {
    document.getElementById("new-game-checkbox").checked = false;
}

// PWA //
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
      .then(reg => console.log("Service Worker registered!", reg))
      .catch(err => console.error("Service Worker registration failed:", err));
  }

// ------------ //


function resetGame() {

    document.getElementById("menu-container").style.display = "none";
    document.getElementsByClassName("menu-item-container")[0].style.width = "70%";

    hideVictoryScreen()
    
    gameSettings.playingAgainstComputer = document.getElementById("new-game-checkbox").checked

    gameState = {
        globalBoard: ["", "", "", "", "", "", "", "", ""],
        subBoards: [
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""]
        ],
        currentPlayer: "X",
        playingAgainstComputer: gameSettings.playingAgainstComputer,
        computerToMove: false,
        activeSubBoard: null,
        lastMove: {
            subBoard: null,
            cell: null,
            player: null
        },
        ended: false,
    };
    
    if (gameSettings.startingPlayer === "?") {
        gameState.currentPlayer = Math.random() < 0.5 ? "X" : "O";
    } else {
        gameState.currentPlayer = gameSettings.startingPlayer
    }
    document.documentElement.style.setProperty("--hoverColor", palettes[activeColorPallete][gameState.currentPlayer === "X" ? "colorX" : "colorO"]);
    document.getElementsByClassName("current-turn")[0].textContent = gameState.currentPlayer;

    squares.forEach((square) => {
        square.classList.remove("square-disabled");
        square.classList.remove("last-square-x");
        square.classList.remove("last-square-o");
        square.textContent = "";

    })

    squareContainers.forEach((container) => {
        container.classList.remove("square-container-complete-x");
        container.classList.remove("square-container-complete-o");
        container.classList.remove("square-container-complete-d");
        container.classList.remove("disabled");
    })

    saveGame();

}

squares.forEach((square, index) => {
    square.addEventListener("click", function(event) {
        const button = event.target;
        const parentElement = event.target.parentElement;
        const grandParentElement = event.target.parentElement.parentElement;
        const buttonRelativeIndex = (Array.from(event.target.parentElement.children).indexOf(event.target));
        const parentIndex = Array.from(event.target.parentElement.parentElement.children).indexOf(event.target.parentElement);

        handleClick(button, buttonRelativeIndex, parentElement, parentIndex, grandParentElement);
    });
});

function saveGame() {

    localStorage.setItem("gameState", JSON.stringify(gameState));

}

function loadGame() {

    if (localStorage.getItem("gameState")) {

        gameState = JSON.parse(localStorage.getItem("gameState"));
        
        if (gameState.ended === true) {
            resetGame();
            return;
        }

        gameState.computerToMove = false;
        document.documentElement.style.setProperty("--hoverColor", palettes[activeColorPallete][gameState.currentPlayer === "X" ? "colorX" : "colorO"]);
        
        
        
        if (gameState.activeSubBoard != null) {

            if (gameState.globalBoard[gameState.activeSubBoard] === "") {
                Array.from(document.getElementsByClassName("square-container")).forEach((container, index) => {
                    if (index != gameState.activeSubBoard) {
                        container.classList.add("disabled");
                    }
                });
            } else {
                Array.from(document.getElementsByClassName("square-container")).forEach((container, index) => {
                    if (gameState.globalBoard[index] != "") {
                        container.classList.add("disabled");
                    }
                });
            }            

            gameState.globalBoard.forEach((square, index) => {
                if (square != "") {
                    document.getElementById(`square-container-${index}`).classList.add(`square-container-complete-${square.toLowerCase()}`, "disabled");
                }
            });

            gameState.subBoards.forEach((subBoard, index) => {
                let squares = document.getElementById(`square-container-${index}`).children;
                subBoard.forEach((square, index) => {
                    squares[index].innerText = square;
                    if (square != "") {
                        squares[index].classList.add("square-disabled");
                    }
                });
            });

            let lastSquare = document.getElementById(`square-container-${gameState.lastMove.subBoard}`).children[gameState.lastMove.cell];
            lastSquare.classList.add(`last-square-${gameState.currentPlayer === "O" ? "x" : "o"}`);
            previousButton = lastSquare;

            let currentTurn = document.getElementsByClassName("current-turn")[0];
            currentTurn.textContent = gameState.currentPlayer === "O" ? "O" : "X";
        }  
    }
}

function handleClick(button, buttonRelativeIndex, parentElement, parentIndex, grandParentElement) {

    Object.assign(gameState.lastMove, {
        subBoard: parentIndex,
        cell: buttonRelativeIndex,
        player: gameState.currentPlayer
    });

    // console.log("button: ", button, "buttonRelativeIndex: ", buttonRelativeIndex, "parentElement: ", parentElement, "parentIndex: ", parentIndex, "grandParentElement: ", grandParentElement);
    gameState.activeSubBoard = buttonRelativeIndex;

    updateGameBoard(button, buttonRelativeIndex, parentIndex);

    saveGame();

    previousButton = button;
    

    // checkForIndividualWinner(parentElement, parentIndex, grandParentElementChildren);

    if (gameState.ended) {
        return;
    }
    if (gameState.playingAgainstComputer === true) {
        gameState.computerToMove = (gameState.computerToMove === false) ? true : false;
        if (gameState.computerToMove === true) {
            gameContainer.style.pointerEvents = "none";
            setTimeout(() => {
                // makeRandomMove();
                makeMCTSMove();
                gameState.computerToMove = false;
                gameContainer.style.pointerEvents = "auto";
            }, Math.random()*300); 
        }
        
    }
}

/// NEW ///

function updateGameBoard(button, buttonRelativeIndex, parentIndex) {

    button.textContent = gameState.currentPlayer;
    gameState.subBoards[parentIndex][buttonRelativeIndex] = gameState.currentPlayer;
    button.classList.add(`last-square-${gameState.currentPlayer.toLowerCase()}`);

    // switches currentPlayer
    gameState.currentPlayer = gameState.currentPlayer === "X" ? "O" : "X";

    document.documentElement.style.setProperty("--hoverColor", palettes[activeColorPallete][gameState.currentPlayer === "X" ? "colorX" : "colorO"]);
    document.getElementsByClassName("current-turn")[0].textContent = gameState.currentPlayer;
    previousButton.classList.remove(`last-square-${gameState.currentPlayer.toLowerCase()}`);

    button.classList.add("square-disabled");
    
    const grandParentElementChildren = Array.from(document.getElementsByClassName("game-container")[0].children);
    checkForIndividualWinner(button.parentElement, parentIndex, grandParentElementChildren);

    // getWin(gameState.subBoard[parentIndex]);

    if (!gameState.ended) {
        
        grandParentElementChildren.forEach((child, index) => {

            if (squareContainers[buttonRelativeIndex].classList.contains("square-container-complete-x") || squareContainers[buttonRelativeIndex].classList.contains("square-container-complete-o") || squareContainers[buttonRelativeIndex].classList.contains("square-container-complete-d")) {

                if (child.classList.contains("square-container-complete-x") || child.classList.contains("square-container-complete-o") || child.classList.contains("square-container-complete-d")) {

                    child.classList.add("disabled");
                    
                } else {

                    child.classList.remove("disabled");

                }

            } else {

                if (index != buttonRelativeIndex) {

                    child.classList.add("disabled");
        
                } else {
        
                    child.classList.remove("disabled");
        
                }

            }

        });
    }

}

/// --- ///


function checkForIndividualWinner(parentElement, parentIndex, grandParentElementChildren) {

    var isWon = false;

    for (let pattern of winPatterns) {

        let pos1 = Array.from(parentElement.children)[pattern[0]].innerText;
        let pos2 = Array.from(parentElement.children)[pattern[1]].innerText;
        let pos3 = Array.from(parentElement.children)[pattern[2]].innerText;

        if (pos1 !== "" && pos2 !== "" && pos3 !== "" && pos1 === pos2 && pos2 === pos3) {

            if (gameState.currentPlayer == "O") {
                parentElement.classList.add("square-container-complete-x");
            } else {
                parentElement.classList.add("square-container-complete-o");
            }
            
            // parentElement.replaceChildren();

            // Array.from(parentElement.children)[pattern[0]].classList.add("square-complete");
            // Array.from(parentElement.children)[pattern[1]].classList.add("square-complete");
            // Array.from(parentElement.children)[pattern[2]].classList.add("square-complete");
            gameState.globalBoard[parentIndex] = pos1;

            gameState.globalBoard[parentIndex] = pos1;

            // console.log(pos1);
            isWon = true;
            checkForWinner(grandParentElementChildren);
            return;

        }
    }

    if (!isWon) {
        // console.log("NOT WON");
        const allSquares = Array.from(parentElement.children).every((square) => square.innerText !== "");
        if (allSquares) {
            gameState.globalBoard[parentIndex] = "D";

            gameState.globalBoard[parentIndex] = "D";                                                                                                  
            parentElement.classList.add("square-container-complete-d");
            // parentElement.replaceChildren();
            // Array.from(parentElement.children).forEach(child => {
            //     child.style.display = "none";
            // })
            console.log("check for global draw")
            checkForWinner(grandParentElementChildren);
        }
    }
    

}

function checkForWinner(grandParentElementChildren) {

    var isWon = false;

    for (let pattern of winPatterns) {

        let pos1 = gameState.globalBoard[pattern[0]];
        let pos2 = gameState.globalBoard[pattern[1]];
        let pos3 = gameState.globalBoard[pattern[2]];

        if (pos1 !== "" && pos2 !== "" && pos3 !== "" && pos1 === pos2 && pos2 === pos3) {

            isWon = true;
            grandParentElementChildren.forEach((child, index) => {
                
                child.classList.add("disabled");

            });
            if (gameState.currentPlayer == "O") {
                showVictoryScreen("X");
            } else {
                showVictoryScreen("O");
            }
            document.getElementsByClassName("current-turn")[0].style.color = "background-color";
            gameState.ended = true;
            return;

        } 

    }

    if (!isWon) {
        if (gameState.globalBoard.every(cell => cell !== "")) {
            showVictoryScreen("D");
            document.getElementsByClassName("current-turn")[0].style.color = "";
        }
    } else {
        console.log("show new game");
        document.getElementsByClassName("current-turn")[0].style.color = "";
    }

}

/// NEW CHECK WIN ///
function getWin(board) {
    for (const line of winPatterns) {
        const [a, b, c] = line;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return board[a];
        }
    }
    if (board.every(cell => cell !== "")) {
        return "D";
    }
    return null;
}


// MENU //
let menu = document.getElementById("menu-container");
let menuShown = false;

function showMenu() {
    menu.style.display = "block";
    menuShown = true;
}

function hideMenu(event) {
    if (event.target == menu) {
        
        menu.style.display = "none";
        if (settingsShown = true) showSettings();
        if (newGameShown = true) showNewGame();
        menuShown = false;
    }
    if (!newGameShown) {    
        if (event.target.matches(".button-container") || event.target.matches(".menu-item-container")) {
            document.getElementById("settings-content").style.display = "none";
            document.getElementById("new-game-content").style.display = "none";
            document.getElementById("new-game-button").style.display = "block";
            document.getElementById("reset-game").style.display = "block";
            document.getElementById("settings-button").textContent = "SETTINGS";
            settingsShown = false;
        }
    }
    
}

window.onclick = function(event) {
    if (menuShown) {
        hideMenu(event);
    }
}

let newGameShown = false;
function showNewGame() {
    hideVictoryScreen();
    if (newGameShown == false) {
        document.getElementById("new-game-content").style.display = "flex";
        document.getElementById("new-game-button").style.display = "none";
        document.getElementById("reset-game").style.display = "none";
        document.getElementById("settings-button").style.display = "none";
        newGameShown = true;
    } else {
        document.getElementById("new-game-content").style.display = "none";
        document.getElementById("new-game-button").style.display = "block";
        document.getElementById("reset-game").style.display = "block";
        document.getElementById("settings-button").style.display = "block";
        newGameShown = false;
    }
}

function changeGameSettings(setting) {
    if (setting === true) {
        gameSettings.playingAgainstComputer = true;
    } else {
        gameSettings.playingAgainstComputer = false;
        if (setting != false) {
            if (setting === "?") {
                gameSettings.startingPlayer = setting;
            } else {
                gameSettings.startingPlayer = setting;
            }
        }
    }
    localStorage.setItem("gameSettings", JSON.stringify(gameSettings));
}

function loadGameSettings() {
    if (localStorage.getItem("gameSettings")) {
        gameSettings = JSON.parse(localStorage.getItem("gameSettings"));
    }
}

function startNewGame() {
    showNewGame();
    resetGame();
}

function showVictoryScreen(result) {
    if (settingsShown = true) showSettings();
    if (newGameShown = true) showNewGame();
    document.getElementById("new-game").style.display = "none";
    document.getElementById("reset-game").style.display = "none";
    document.getElementById("new-game").style.display = "none";
    document.getElementById("new-game-content").style.display = "none";
    document.getElementById("settings-button").style.display = "none";
   
    document.getElementsByClassName("current-turn")[0].style.color = palettes[activeColorPallete].backgroundColor;

    document.getElementById("victory-screen").style.display = "grid";

    menu.style.display = "block";
    document.getElementsByClassName("menu-item-container")[0].style.width = "50%";

    if (result != null) {
        if (result != "D") {
            document.getElementById("victory-label").textContent = `${result} WON!`;
        } else {
            document.getElementById("victory-label").textContent = "DRAW";
        }
    }
}

function hideVictoryScreen() {
    document.getElementById("victory-screen").style.display = "none";

    document.getElementById("new-game-button").style.display = "block";
    document.getElementById("reset-game").style.display = "block";
    document.getElementById("new-game-content").style.display = "none";
    document.getElementById("settings-button").style.display = "block";
}

function loadSettings() {

    const toggle = document.getElementById("contrast-toggle");
    const savedContrastSetting = localStorage.getItem("highContrast");
    if (savedContrastSetting) {
      document.documentElement.style.colorScheme = savedContrastSetting;
      toggle.checked = savedContrastSetting === "dark";
    } else {
        localStorage.setItem("highContrast", "dark");
    }
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
        colorPalletes.forEach((palette) => {
        if (palette.id === savedTheme) {
            activeColorPallete = savedTheme;
            document.getElementById(`theme-radio-${savedTheme}`).checked = true;
            loadTheme(activeColorPallete);
        }  
    });
    } else {
        activeColorPallete = "standardPallete";
        loadTheme(activeColorPallete);
    }

}

let settingsShown = false;
function showSettings() {
    if (settingsShown == false) {
        document.getElementById("settings-content").style.display = "block";
        document.getElementById("new-game-button").style.display = "none";
        document.getElementById("reset-game").style.display = "none";
        document.getElementById("settings-button").textContent = "CLOSE SETTINGS";
        settingsShown = true;
    } else {
        document.getElementById("settings-content").style.display = "none";
        document.getElementById("new-game-button").style.display = "block";
        document.getElementById("reset-game").style.display = "block";
        document.getElementById("settings-button").textContent = "SETTINGS";
        settingsShown = false;
    }
}

function toggleContrast() {
    const toggle = document.getElementById("contrast-toggle");
    const contrast = toggle.checked ? "dark" : "light";
    document.documentElement.style.colorScheme = contrast;
    localStorage.setItem("highContrast", contrast);
}

function loadThemeButtons() {

    const radioList = document.getElementById("theme-radio-list");
    
    colorPalletes.forEach((palette, i) => {
    
        const label = document.createElement("label");
        label.className = "theme-radio-label";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "theme-selection";
        input.value = palette.id;
        input.id = `theme-radio-${palette.id}`;
        if (i === 0) input.checked = true;

        const span = document.createElement("span");
        span.textContent = palette.label;

        label.appendChild(input);
        label.appendChild(span);
        radioList.appendChild(label);
    });

    const themeRadios = document.querySelectorAll("input[name='theme-selection']");

    themeRadios.forEach(radio => {
        radio.addEventListener("change", function() {
            if (this.checked) {
                activeColorPallete = this.value;
                localStorage.setItem("theme", activeColorPallete); 
                loadTheme(activeColorPallete);
            }
        });
    });
}

function loadTheme(selectedTheme) {
    document.documentElement.style.setProperty("--backgroundColor", palettes[selectedTheme].backgroundColor);
    document.documentElement.style.setProperty("--textColor", palettes[selectedTheme].textColor);
    document.documentElement.style.setProperty("--menuButtonColor", palettes[selectedTheme].menuButtonColor);
    document.documentElement.style.setProperty("--squareBorder", palettes[selectedTheme].squareBorder);
    document.documentElement.style.setProperty("--lightSquareBorder", palettes[selectedTheme].lightSquareBorder);
    document.documentElement.style.setProperty("--disabledSquareBorder", palettes[selectedTheme].disabledSquareBorder);
    document.documentElement.style.setProperty("--colorO", palettes[selectedTheme].colorO);
    document.documentElement.style.setProperty("--colorX", palettes[selectedTheme].colorX);
    if (gameState.currentPlayer === "X") {
        document.documentElement.style.setProperty("--hoverColor", palettes[selectedTheme].colorX);
    } else {
        document.documentElement.style.setProperty("--hoverColor", palettes[selectedTheme].colorO);
    }
    
}  

/// RANDOM MOVE ///
function makeRandomMove() {

    const moves = getValidMoves(gameState);
    let randomMove = moves[Math.floor(Math.random() * moves.length)];
    let buttonIndex;

    if (randomMove.subBoard > 0) {
        buttonIndex = randomMove.cell + (9 * randomMove.subBoard);
    } else {
        buttonIndex = randomMove.cell;
    }

    button = document.getElementsByClassName("square")[buttonIndex];
    buttonRelativeIndex = randomMove.cell;
    parentElement = document.getElementsByClassName("square-container")[randomMove.subBoard]
    parentIndex = randomMove.subBoard;
    grandParentElement = document.getElementsByClassName("game-container")[0];

    handleClick(button, buttonRelativeIndex, parentElement, parentIndex, grandParentElement);
}



/// MONTE CARLO TREE SEARCH ///

// GET VALID MOVES //

//returns an Array of Objects each containing a subBoard and cell with the index
function getValidMoves(state) {
    const { activeSubBoard, subBoards } = state;
    if (activeSubBoard !== null && !isSubBoardComplete(subBoards[activeSubBoard])) {
        return getEmptyCells(subBoards[activeSubBoard]).map(cell => ({
            subBoard: activeSubBoard,
            cell
        }));
    }
    return subBoards.flatMap((board, index) => 
        isSubBoardComplete(board) ? [] : getEmptyCells(board).map(cell => ({ subBoard: index, cell }))
    );
}

function getEmptyCells(board) {
    const cells = [];
    board.forEach((cell, index) => {
        if (cell === "") cells.push(index);
    });
    return cells;
}

function isSubBoardComplete(board) {
    return checkWin(board) || board.every(cell => cell !== "");
}

function checkWin(board) {
    for (const line of winPatterns) {
        const [a, b, c] = line;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return board[a];
        }
    }
    if (board.every(cell => cell !== "")) {
        return "D";
    }
    return null;
}

function isGameOver(state) {
    return checkWin(state.globalBoard) != null
}

function deepCopy(obj) {
    return JSON.parse(JSON.stringify(obj));
}

// GET VALID MOVES END //

// NODE //
class Node {
    constructor(state, parent = null, move = null) {
        this.state = state; // The game state at this node
        this.parent = parent; // Parent node
        this.children = []; // Child nodes
        this.visits = 0; // Number of times this node has been visited
        this.wins = 0; // Number of wins from this node
        this.draws = 0;
        this.move = move; // The move that led to this state
        this.untriedMoves = getValidMoves(state);
    }

    isFullyExpanded() {
        return this.untriedMoves.length === 0;
    }
}

// SELECT //
function select(node) {
    while (node.children.length > 0) {
        node = node.children.reduce((bestChild, child) => {
            const ucb1 = (child.wins / (child.visits || 1)) +
                         Math.sqrt(2 * Math.log(node.visits + 1) / (child.visits || 1));
            const bestUcb1 = (bestChild.wins / (bestChild.visits || 1)) +
                             Math.sqrt(2 * Math.log(node.visits + 1) / (bestChild.visits || 1));
            return ucb1 > bestUcb1 ? child : bestChild;
        }, node.children[0]);
    }
    return node;
}

// EXPAND //
function expand(node) {
    if (node.isFullyExpanded()) return node;

    const idx = Math.floor(Math.random() * node.untriedMoves.length);
    const move = node.untriedMoves.splice(idx, 1)[0];
    const newState = applyMove(node.state, move)
    const childNode = new Node(newState, node, move);
    node.children.push(childNode);
    return childNode;
}

// SIMULATE //
function simulate(state) {
    let currentState = deepCopy(state);
    while (!isGameOver(currentState)) {
        const moves = getValidMoves(currentState);
        const randomMove = moves[Math.floor(Math.random() * moves.length)];
        currentState = applyMove(currentState, randomMove);
    }
    return checkWin(currentState.globalBoard); // Returns "X", "O", "D" or null for still going.
}

function applyMove(state, move) {
    let newState = deepCopy(state);
    newState.activeSubBoard = move.subBoard;
    newState.subBoards[move.subBoard][move.cell] = state.currentPlayer;
    let winState = checkWin(newState.subBoards[move.subBoard]);
    if (winState != null) {
        newState.globalBoard[move.subBoard] = winState;
    }
    newState.currentPlayer = state.currentPlayer === "X" ? "O" : "X";
    return newState;
}

// BACK PROGAGATE //
function backpropagate(node, result, lookingFor) {

    while (node !== null) {
        node.visits++;
        if (result === lookingFor) {
            node.wins++;
        }
        node = node.parent;
    }
}

// MCTS //
function monteCarloTreeSearch(rootState, iterations) {

    const searchState = deepCopy(rootState);
    const lookingFor = searchState.currentPlayer;
    const rootNode = new Node(searchState);

    for (let i = 0; i < iterations; i++) {
        let node = select(rootNode); // Selection
        if (!isGameOver(node.state)) {
            node = expand(node); // Expansion
        }
        const result = simulate(node.state); // Simulation
        backpropagate(node, result, lookingFor); // Backpropagation
    }

    if (rootNode.children.length === 0) {
        return null;
    }

    console.log("FINAL STATE: ", rootNode, " looked for: ", lookingFor);
    return rootNode.children.reduce((bestChild, child) => 
        child.visits > bestChild.visits ? child : bestChild).move;
}

function makeMCTSMove() {

    computerToMove = true;

    let move = monteCarloTreeSearch(gameState, 10000);

    if (move.subBoard > 0) {
        buttonIndex = move.cell + (9 * move.subBoard);
    } else {
        buttonIndex = move.cell;
    }

    button = document.getElementsByClassName("square")[buttonIndex];
    buttonRelativeIndex = move.cell;
    parentElement = document.getElementsByClassName("square-container")[move.subBoard]
    parentIndex = move.subBoard;
    grandParentElement = document.getElementsByClassName("game-container")[0];

    handleClick(button, buttonRelativeIndex, parentElement, parentIndex, grandParentElement);
}